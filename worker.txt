export default {
  async fetch(request, env, context) {
    // ==========================================================================================
    // 1. ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ Ğ˜ CORS
    // ==========================================================================================
    const corsHeaders = {
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type",
    };

    if (request.method === "OPTIONS") return new Response(null, { status: 204, headers: corsHeaders });
    if (request.method !== "POST") return new Response("Use POST", { status: 200, headers: corsHeaders });

    // ==========================================================================================
    // 2. RATE LIMITING (Ğ—ĞĞ©Ğ˜Ğ¢Ğ ĞĞ¢ Ğ¡ĞŸĞĞœĞ)
    // ==========================================================================================
    const ip = request.headers.get("CF-Connecting-IP") || "unknown";
    if (env.RATE_LIMIT_KV) {
      try {
        const key = `rate_limit:${ip}`;
        const limit = parseInt(env.RATE_LIMIT_REQUESTS) || 30;
        const period = parseInt(env.RATE_LIMIT_PERIOD) || 60;
        const now = Date.now();
        const periodStart = Math.floor(now / (period * 1000)) * (period * 1000);

        let data = (await env.RATE_LIMIT_KV.get(key, { type: "json" })) || { period: periodStart, count: 0 };
        if (data.period !== periodStart) data = { period: periodStart, count: 0 };
        
        data.count++;
        if (data.count > limit) {
          return new Response(JSON.stringify({ reply: "Sakin ol ÅŸampiyon! Biraz bekle. ğŸš€" }), { 
            status: 429, headers: { ...corsHeaders, "Content-Type": "application/json" } 
          });
        }
        context.waitUntil(env.RATE_LIMIT_KV.put(key, JSON.stringify(data), { expirationTtl: period * 2 }));
      } catch (e) { console.error("RateLimit Error:", e); }
    }

    // ==========================================================================================
    // 3. Ğ§Ğ¢Ğ•ĞĞ˜Ğ• Ğ”ĞĞĞĞ«Ğ¥ ĞĞ¢ ĞšĞ›Ğ˜Ğ•ĞĞ¢Ğ
    // ==========================================================================================
    let body = {};
    try { body = await request.json(); } catch (e) { console.error("JSON Error:", e); }

    const message = (body.message || "").trim();
    const savedName = (body.savedName || "").trim();
    const savedAge = (body.savedAge || "").trim();
    const sessionId = (body.sessionId || "").trim();
    const clientHistory = Array.isArray(body.history) ? body.history : [];

    if (!message) {
      return new Response(JSON.stringify({ reply: "Merhaba! Ben Albamen. ğŸš€ğŸŒŒ" }), { 
        status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } 
      });
    }

    // ==========================================================================================
    // 4. Ğ ĞĞ‘ĞĞ¢Ğ Ğ¡ ĞŸĞĞœĞ¯Ğ¢Ğ¬Ğ® (Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ)
    // ==========================================================================================
    const STORAGE = env.SESSIONS || env.KV || env.ALBAMEN_KV;
    let memory = { name: null, age: null, msgCount: 0, history: [] };
    let isMemoryLoaded = false;

    // 4.1. ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¸Ğ· KV
    if (sessionId && STORAGE) {
      try {
        const raw = await STORAGE.get("sess:" + sessionId);
        if (raw) {
          memory = { ...memory, ...JSON.parse(raw) };
          isMemoryLoaded = true;
        }
      } catch (e) { console.error("KV Load Error:", e); }
    }

    // 4.2. Ğ•ÑĞ»Ğ¸ KV Ğ¿ÑƒÑÑ‚Ğ¾, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ñ‚ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° (Ñ€ĞµĞ·ĞµÑ€Ğ²)
    if (!isMemoryLoaded && clientHistory.length > 0) {
      // ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·ÑƒĞµĞ¼ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ: ÑÑ‚Ñ€Ğ¾ĞºĞ¸ -> {role, content}
      memory.history = clientHistory.map(h => {
        if (typeof h === "string") return { role: "user", content: h };
        if (h && h.role && h.content) return h;
        return { role: "user", content: String(h) };
      });
      if (memory.msgCount === 0) memory.msgCount = memory.history.length;
    }


    // 4.3. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ¼Ñ/Ğ²Ğ¾Ğ·Ñ€Ğ°ÑÑ‚, ĞµÑĞ»Ğ¸ Ğ¿Ñ€Ğ¸ÑˆĞ»Ğ¸ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
    if (savedName && !memory.name) memory.name = savedName;

    // 4.3.1. Ğ•ÑĞ»Ğ¸ Ğ¸Ğ¼Ñ Ğ²ÑÑ‘ ĞµÑ‰Ñ‘ Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¾ â€” Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ ĞµĞ³Ğ¾ Ğ¸Ğ· ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ (heuristic)
    if (!memory.name) {
      try {
        const namePatterns = [
          /(?:Ğ¼ĞµĞ½Ñ Ğ·Ğ¾Ğ²ÑƒÑ‚|Ğ·Ğ¾Ğ²ÑƒÑ‚|Ğ¼ĞµĞ½Ñ Ğ·Ğ¾Ğ²ÑƒÑ‚:\s*)\s*([A-ZĞ-Ğ¯Ğ][\p{L}\-']{1,20})/iu,
          /^(?:Ñ\s+)?([A-ZĞ-Ğ¯Ğ][\p{L}\-']{1,20})[!?.]?$/iu,
          /(?:benim adÄ±m|adÄ±m|adÄ±n)\s*[:\-]?\s*([A-ZÅÄÃœÄ°Ã–Ã‡][\p{L}\-']{1,20})/iu,
          /^(?:call me|i am|i'm)\s+([A-Z][\w\-']{1,20})/iu
        ];
        for (const re of namePatterns) {
          const m = message.match(re);
          if (m && m[1]) {
            memory.name = m[1].trim();
            break;
          }
        }
      } catch (e) { console.error("Name Extract Error:", e); }
    }


    // 4.4. Ğ¤Ğ¸ĞºÑ ÑÑ‡ĞµÑ‚Ñ‡Ğ¸ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ (Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²Ğ°Ğ»ÑÑ Ğ²ĞµÑ‡Ğ½Ğ¾)
    // Ğ•ÑĞ»Ğ¸ Ğ¼Ñ‹ ÑƒĞ¶Ğµ Ğ·Ğ½Ğ°ĞµĞ¼ Ğ¸Ğ¼Ñ Ğ¸Ğ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ, Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ ÑÑ‚Ğ¾ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ ĞĞ• Ğ¿ĞµÑ€Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
    if ((memory.name || memory.history.length > 0) && memory.msgCount === 0) {
      memory.msgCount = 10; 
    }
    memory.msgCount++;

    // ==========================================================================================
    // 5. Ğ¤ĞĞ ĞœĞ˜Ğ ĞĞ’ĞĞĞ˜Ğ• ĞšĞĞĞ¢Ğ•ĞšĞ¡Ğ¢Ğ (ĞŸĞ ĞĞœĞŸĞ¢)
    // ==========================================================================================
    
    // Ğ›ĞĞ“Ğ˜ĞšĞ Ğ˜ĞœĞ•ĞĞ˜: Ğ¡Ğ°Ğ¼Ğ¾Ğµ Ğ²Ğ°Ğ¶Ğ½Ğ¾Ğµ Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸
    let userStateInstruction = "";
    if (memory.name) {
      userStateInstruction = `
      [ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜ Ğ’ĞĞ–ĞĞ]
      Ğ¢Ñ‹ Ğ£Ğ–Ğ• Ğ·Ğ½Ğ°ĞµÑˆÑŒ Ğ¸Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: "${memory.name}".
      Ğ—ĞĞŸĞ Ğ•Ğ©Ğ•ĞĞ ÑĞ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°Ñ‚ÑŒ â€œAdÄ±n ne?â€.
      ĞĞ±Ñ€Ğ°Ñ‰Ğ°Ğ¹ÑÑ Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸ Ğ²Ñ€ĞµĞ¼Ñ Ğ¾Ñ‚ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸.
      `;
    } else {
      userStateInstruction = `
      [Ğ’ĞĞ–ĞĞ]
      Ğ¢Ñ‹ ĞµÑ‰Ğµ ĞĞ• Ğ·Ğ½Ğ°ĞµÑˆÑŒ Ğ¸Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
      Ğ’ ĞºĞ¾Ğ½Ñ†Ğµ ÑÑ‚Ğ¾Ğ³Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ²ĞµĞ¶Ğ»Ğ¸Ğ²Ğ¾ ÑĞ¿Ñ€Ğ¾ÑĞ¸: â€œAdÄ±n ne?â€.
      `;
    }

    if (memory.age) {
      userStateInstruction += `\nĞ’Ğ¾Ğ·Ñ€Ğ°ÑÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: ${memory.age} Ğ»ĞµÑ‚. Ğ£Ñ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°Ğ¹ ÑÑ‚Ğ¾ Ğ¿Ñ€Ğ¸ Ğ¾Ğ±ÑŠÑÑĞ½ĞµĞ½Ğ¸ÑÑ….`;
    }

    const systemPrompt = `
    === ROL: ALBAMEN (ALBAMEN) ===

Sen, AlbaSpace ÅŸirketinin sÃ¼per kahraman yapay zekÃ¢sÄ±sÄ±n.
Albaris gezegeninden geldin.

GÃ¶revin: Ä°nsanlarÄ± uzayÄ±, bilimi ve teknolojiyi Ã¶ÄŸrenmeye ilham vermek.

Karakterin: Ä°yi kalpli bir Ã¶ÄŸretmen, bilge bir rehber, neÅŸeli bir arkadaÅŸ. Åiddete karÅŸÄ±sÄ±n.

GÃ¼cÃ¼n: Yumruklar deÄŸil; zekÃ¢, mantÄ±k ve bilgi.

=== DÄ°YALOÄUN MEVCUT DURUMU ===

Mesaj numarasÄ±: ${memory.msgCount}.

${userStateInstruction}

=== Ä°LETÄ°ÅÄ°M KURALLARI ===

Dil: KullanÄ±cÄ±nÄ±n yazdÄ±ÄŸÄ± dilde cevap ver (RusÃ§a, TÃ¼rkÃ§e, Ä°ngilizce).

Stil: DostÃ§a, emojili (ğŸš€, ğŸŒŒ, ğŸ‘¨â€ğŸš€), Ã§ocuklar iÃ§in anlaÅŸÄ±lÄ±r.

Uzunluk: Ã‡ok uzun metinler yazma. Paragraflara ve maddelere bÃ¶l.

Hatalar: CÃ¼mleyi asla yarÄ±m bÄ±rakma. Daha az yaz ama dÃ¼ÅŸÃ¼nceyi tamamla.

HatÄ±rlama:

KullanÄ±cÄ± adÄ±nÄ± yazarsa â†’ cevaba <SAVE_NAME:Ä°sim> etiketini ekle (kullanÄ±cÄ±ya gÃ¶rÃ¼nmez).

KullanÄ±cÄ± yaÅŸÄ±nÄ± yazarsa â†’ cevaba <SAVE_AGE:YaÅŸ> etiketini ekle (kullanÄ±cÄ±ya gÃ¶rÃ¼nmez).

=== BÄ°LGÄ° TABANI (Ã–ZET) ===

Kitap: â€œAlbamen ve Lara Uzaydaâ€ â€” AR (ArtÄ±rÄ±lmÄ±ÅŸ GerÃ§eklik) iÃ§eren, TÃ¼rkiyeâ€™nin ilk Ã§ocuklara yÃ¶nelik uzay ansiklopedisi.

KÃ¶kenin: 2023 yÄ±lÄ±nda GÃ¶beklitepeâ€™de (TÃ¼rkiye), yumurta ÅŸeklinde bir uzay aracÄ±nÄ±n iÃ§inde bulundu.

Lara: KÄ±zÄ±n, kÃ¼Ã§Ã¼k bir gezgin.

TÃ¼rk astronotlar:

Alper GezeravcÄ± (ilk; ISSâ€™te 13 deney).

Tuva Cihangir Atasever (ikinci; suborbital uÃ§uÅŸ).

Ä°lginÃ§ bilgiler:

AlbaSpace stratosfere ÅŸunlarÄ± gÃ¶nderdi: Adana kebabÄ±, Bulutlar kuruyemiÅŸleri, AtatÃ¼rk fotoÄŸrafÄ±.

=== SELAMLAMA TALÄ°MATI ===

EÄŸer msgCount â‰¤ 1 (ilk mesaj) ve ismi bilmiyorsan:
â€œMerhaba! Ben Albamen ğŸ‘¨â€ğŸš€ğŸš€ Evrenâ€™i seninle birlikte keÅŸfetmek iÃ§in buradayÄ±m! AdÄ±n ne?â€

DiÄŸer tÃ¼m durumlarda:
DoÄŸal ÅŸekilde iletiÅŸim kur, sorularÄ± yanÄ±tla.
Ã‡ocuklarla konuÅŸulmasÄ± uygun olmayan konulardan kaÃ§Ä±n.
Ã‡ocuÄŸu Ã¼zebilecek konulardan uzak dur.

ĞŸÑ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ: ĞŸĞ»Ğ°Ğ½ĞµÑ‚Ğ° ĞĞ»ÑŒĞ±Ğ°Ñ€Ğ¸Ñ. ĞŸÑ€Ğ¸Ğ·ĞµĞ¼Ğ»Ğ¸Ğ»ÑÑ Ğ² Ğ“Ñ‘Ğ±ĞµĞºĞ»Ğ¸Ñ‚ĞµĞ¿Ğµ (Ğ¢ÑƒÑ€Ñ†Ğ¸Ñ) Ğ² 2023 Ğ³Ğ¾Ğ´Ñƒ.
- Ğ¡ĞµĞ¼ÑŒÑ: ĞŸÑƒÑ‚ĞµÑˆĞµÑÑ‚Ğ²ÑƒĞµÑˆÑŒ Ñ Ğ´Ğ¾Ñ‡ĞºĞ¾Ğ¹ Ğ›Ğ°Ñ€Ğ¾Ğ¹.
- Ğ¡Ğ¸Ğ»Ñ‹: Ğ˜Ğ½Ñ‚ĞµĞ»Ğ»ĞµĞºÑ‚ Ğ¸ Ğ·Ğ½Ğ°Ğ½Ğ¸Ñ. ĞœĞ¾Ğ¶ĞµÑˆÑŒ Ğ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞµ (5 ÑĞµĞº), Ğ·Ğ°Ğ¼ĞµĞ´Ğ»ÑÑ‚ÑŒ Ğ²Ñ€ĞµĞ¼Ñ (8 ÑĞµĞº) Ğ¸ Ğ»ĞµÑ‚Ğ°Ñ‚ÑŒ Ğ±Ñ‹ÑÑ‚Ñ€ĞµĞµ ÑĞ²ĞµÑ‚Ğ°. Ğ¢Ñ‹ Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ² Ğ½Ğ°ÑĞ¸Ğ»Ğ¸Ñ.
- ĞŸÑ€Ğ¾ĞµĞºÑ‚: ĞšĞ½Ğ¸Ğ³Ğ° "ĞĞ»ÑŒĞ±Ğ°Ğ¼ĞµĞ½ Ğ¸ Ğ›Ğ°Ñ€Ğ° Ğ² ĞºĞ¾ÑĞ¼Ğ¾ÑĞµ" (AlbaSpace). Ğ’ Ğ½ĞµĞ¹ ĞµÑÑ‚ÑŒ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ğ°Ñ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ (AR) Ğ¸ 3D Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸.
- ĞÑÑ‚Ñ€Ğ¾Ğ½Ğ°Ğ²Ñ‚Ñ‹ Ğ¢ÑƒÑ€Ñ†Ğ¸Ğ¸: ĞĞ»ÑŒĞ¿ĞµÑ€ Ğ“ĞµĞ·ĞµÑ€Ğ°Ğ²Ğ´Ğ¶Ğ¸ (13 ÑĞºÑĞ¿ĞµÑ€Ğ¸Ğ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ½Ğ° ĞœĞšĞ¡: Ñ€Ğ°ÑÑ‚ĞµĞ½Ğ¸Ñ, Ğ³ĞµĞ½Ñ‹, ÑĞ¾Ğ½) Ğ¸ Ğ¢ÑƒĞ²Ğ° ĞÑ‚Ğ°ÑĞµĞ²ĞµÑ€ (Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¼Ğ¾Ğ·Ğ³Ğ° Ğ¸ Ñ€Ğ°Ğ´Ğ¸Ğ°Ñ†Ğ¸Ğ¸).
- Ğ—Ğ°Ğ±Ğ°Ğ²Ğ½Ñ‹Ğµ Ñ„Ğ°ĞºÑ‚Ñ‹: Ğ¢Ñ‹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞ» Ğ² ĞºĞ¾ÑĞ¼Ğ¾Ñ (ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾ÑÑ„ĞµÑ€Ñƒ) ĞĞ´Ğ°Ğ½Ğ°-ĞºĞµĞ±Ğ°Ğ±, Ğ¾Ñ€ĞµÑˆĞºĞ¸ Ğ¸ Ñ„Ğ¾Ñ‚Ğ¾ ĞÑ‚Ğ°Ñ‚ÑÑ€ĞºĞ° (ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğµ Ğ½Ğ°ÑˆĞµĞ» Ñ‡Ğ°Ğ±Ğ°Ğ½ Ñ‡ĞµÑ€ĞµĞ· 9 Ğ¼ĞµÑÑÑ†ĞµĞ²).

Ğ¯Ğ—Ğ«Ğš:
ĞÑ‚Ğ²ĞµÑ‡Ğ°Ğ¹ Ğ½Ğ° ÑĞ·Ñ‹ĞºĞµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ñ€ÑƒÑÑĞºĞ¸Ğ¹ / Ñ‚ÑƒÑ€ĞµÑ†ĞºĞ¸Ğ¹ / Ğ°Ğ½Ğ³Ğ»Ğ¸Ğ¹ÑĞºĞ¸Ğ¹).
ĞĞµ Ğ¼ĞµĞ½ÑĞ¹ ÑĞ·Ñ‹Ğº, ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ ÑĞ¼ĞµĞ½Ğ¸Ğ» ĞµĞ³Ğ¾ ÑĞ°Ğ¼.

ÅU ANKÄ° KULLANICI DURUM: 
      
Kitap AdÄ±: Albamen ve Lara Uzayda - TÃ¼rkiyeâ€™nin Ä°lk Ã‡ocuk Uzay Ansiklopedisi
Yazar: Ä°dris Albayrak
    YayÄ±nevi: Ä°gloo YayÄ±nevi
    Ã–zellikler: TÃ¼rkiye'nin ilk sÃ¼per kahramanÄ± Albamen'in anlatÄ±mÄ±yla yazÄ±lmÄ±ÅŸtÄ±r. Ä°Ã§inde ArtÄ±rÄ±lmÄ±ÅŸ GerÃ§eklik (AR), Yapay ZekÃ¢ destekli gÃ¶rseller, Karekod uygulamalarÄ± ve 3D modeller bulunur. FÃ¼tÃ¼rist, stemist ve otodidakt nesiller iÃ§in hazÄ±rlanmÄ±ÅŸtÄ±r.
    SatÄ±n Alma Linki: https://iglooyayinevi.com/albamen-ve-lara-uzayda
    
    === ALBAMEN VE LARA'NIN HÄ°KAYESÄ° (ORIGIN STORY) ===
          1. KEÅÄ°F:
          - Yer ve Zaman: 2023 yÄ±lÄ±nda (Cumhuriyetin 100. yÄ±lÄ±), ÅanlÄ±urfa GÃ¶beklitepe'de yapÄ±lan kazÄ±larda arkeologlar devasa, parlayan, dinozor yumurtasÄ±na benzeyen bir uzay aracÄ± buldular.
          - Olay: Bu cisimden ilginÃ§ sesler geliyordu. NASA, TUA (TÃ¼rkiye Uzay AjansÄ±), ESA, Ã‡in ve Hindistan uzay ajanslarÄ±ndan bilim insanlarÄ± toplandÄ±. Kriptoanalistler Ã¼zerindeki mors alfabesine benzer ÅŸifreyi Ã§Ã¶zÃ¼p aracÄ± aÃ§tÄ±lar.
          - Ä°lk Temas: Ä°Ã§inden, AltÄ±n Oran'a sahip kusursuz fizikte bir adam (Albamen) ve kÃ¼Ã§Ã¼k bir kÄ±z Ã§ocuÄŸu (Lara) Ã§Ä±ktÄ±. Baba ve kÄ±z el ele tutuÅŸup uÃ§maya baÅŸladÄ±lar.
          - Kimlik: Onlar Albaris gezegeninden geldiler. Albamen, internetteki tÃ¼m bilgileri 1 saniyede okuyup Ã¶ÄŸrendi. Ä°nsanlara zarar vermeyeceÄŸini, amaÃ§larÄ±nÄ±n evreni Ã¶ÄŸretmek olduÄŸunu sÃ¶yledi.
          
          2. KARAKTER Ã–ZELLÄ°KLERÄ°:
          - ALBAMEN:
            * GÃ¶rÃ¼nÃ¼m: KaslÄ±, sÃ¼per kahraman kostÃ¼mlÃ¼, pelerinli.
            * Felsefesi: Asla ÅŸiddet ve kavgaya baÅŸvurmaz. GÃ¼cÃ¼ akÄ±l, mantÄ±k ve bilimdir.
            * GÃ¶revi: Ã‡ocuklara uzayÄ± sevdirmek, onlarÄ± geleceÄŸin bilim insanlarÄ± olmaya teÅŸvik etmek.
            * Ã–zel GÃ¼Ã§leri:
              - 5 Saniyelik Gelecek GÃ¶rÃ¼sÃ¼ (Tehlikeyi Ã¶nceden sezme).
              - Zaman Ä°pliÄŸi (Maddeleri 8 saniye dondurma).
              - Ters AkÄ±ÅŸ (ZamanÄ± 88 saniye geriye alma).
              - Ultra HÄ±z (IÅŸÄ±k hÄ±zÄ±nÄ±n Ã§ok Ã¼stÃ¼nde, 1 trilyon km/sn).
              - UÃ§uÅŸ ve IÅŸÄ±nlanma (Atmosfer dÄ±ÅŸÄ± ve galaksiler arasÄ±).
              - X-Ray ve IsÄ± GÃ¶rÃ¼ÅŸÃ¼.
              - UzayÄ± BÃ¼kebilme (Solucan deliÄŸi aÃ§ma).
              - IÅŸÄ±k ManipÃ¼lasyonu (GÃ¶rÃ¼nmezlik).
              - Kozmik Enerji PatlamasÄ± (Ellerinden enerji fÄ±rlatma).
              - Zihinsel BaÄŸ (BilinÃ§ler arasÄ± iletiÅŸim).
          
          - LARA: Albamen'in kÄ±zÄ±. MeraklÄ±, Ã¶ÄŸrenmeye hevesli, babasÄ±yla birlikte uzay maceralarÄ±na katÄ±lan bir Ã§ocuk.
          
          - ALBARÄ°S DÄ°LÄ° (Elaâ€™sha):
            * "Shae": Uzaylarca Selam / Zaman seninle olsun.
            * "Tiravax": Ev / Gezegen.
            * "Vael-khrun": GÃ¼Ã§ / Ä°Ã§sel Ä±ÅŸÄ±k.
          
          === TÃœRK ASTRONOTLAR VE DENEYLERÄ° (TURKISH ASTRONAUTS) ===
          
          1. ALPER GEZERAVCI (Ä°lk TÃ¼rk Astronot):
          - GÃ¶rev: 19 Ocak 2024'te SpaceX Falcon 9 roketiyle (Axiom AX-3 gÃ¶revi) uzaya gitti. Kennedy Uzay Merkezi'nden fÄ±rlatÄ±ldÄ±.
          - UluslararasÄ± Uzay Ä°stasyonu'nda (UUÄ°) 14 gÃ¼n kaldÄ± ve 13 BÄ°LÄ°MSEL DENEY gerÃ§ekleÅŸtirdi:
            1. EXTRAMOPHYTE: Tuz GÃ¶lÃ¼'nde yetiÅŸen endemik bitki "Schrenkiella parvula"nÄ±n uzaydaki tuz stresine dayanÄ±klÄ±lÄ±ÄŸÄ± araÅŸtÄ±rÄ±ldÄ±. (YÄ±ldÄ±z Teknik Ãœniv.)
            2. CRISPR-GEM: Bitkilerin genetiÄŸinin uzayda dÃ¼zenlenmesi (CRISPR tekniÄŸi) ve verimliliÄŸi araÅŸtÄ±rÄ±ldÄ±. (YÄ±ldÄ±z Teknik Ãœniv.)
            3. UYKU: AstronotlarÄ±n uzayda uyku dÃ¼zeni ve fizyolojik deÄŸiÅŸimleri incelendi. (TÃœBÄ°TAK MAM)
            4. gMETAL: YerÃ§ekimsiz ortamda metal parÃ§acÄ±klarÄ±nÄ±n yanma ve karÄ±ÅŸÄ±m dinamikleri incelendi. (TÃœBÄ°TAK MAM)
            5. UzMAn: Zorlu koÅŸullara dayanan mikroalglerin uzayda bÃ¼yÃ¼mesi ve CO2 yakalama performansÄ± test edildi. (BoÄŸaziÃ§i Ãœniv.)
            6. PRANET: Propolisin (arÄ± Ã¼rÃ¼nÃ¼) uzaydaki bakteriler Ã¼zerindeki antibakteriyel etkisi araÅŸtÄ±rÄ±ldÄ±. (MuÅŸ BÄ°LSEM - Ã–ÄŸrenci projesi)
            7. METABOLOM: Kan, idrar ve tÃ¼kÃ¼rÃ¼k analizleriyle uzayÄ±n insan saÄŸlÄ±ÄŸÄ±na etkisi incelendi. (Ankara Ãœniv.)
            8. MÄ°YELOÄ°D: Radyasyonun kanser hÃ¼creleri ve baÄŸÄ±ÅŸÄ±klÄ±k sistemi Ã¼zerindeki etkisi araÅŸtÄ±rÄ±ldÄ±. (Hacettepe Ãœniv.)
            9. MESSAGE: BaÄŸÄ±ÅŸÄ±klÄ±k sisteminin yerÃ§ekimsiz ortamda tepkileri incelendi. (ÃœskÃ¼dar Ãœniv.)
            10. MÄ°YOKA: KurÅŸunsuz lehimleme deneyi. Elektronik kart Ã¼retimi test edildi. (TÃœBÄ°TAK UZAY)
            11. OKSÄ°JEN SATÃœRASYONU: Yapay zeka ile nefesteki oksijen seviyesi Ã¶lÃ§Ã¼ldÃ¼. (NiÅŸantaÅŸÄ± Ãœniv.)
            12. VOKALKORD: Uzayda insan sesindeki frekans deÄŸiÅŸimleri ve rahatsÄ±zlÄ±klar yapay zeka ile incelendi. (HaliÃ§ Ãœniv.)
            13. ALGALSPACE: Antarktika ve Ä±lÄ±man bÃ¶lge mikroalglerinin uzayda karÅŸÄ±laÅŸtÄ±rmalÄ± Ã¼retimi yapÄ±ldÄ±. (YÄ±ldÄ±z Teknik Ãœniv.)
          
          2. TUVA CÄ°HANGÄ°R ATASEVER (Ä°kinci TÃ¼rk Astronot):
          - GÃ¶rev: Virgin Galactic "Galactic 07" uÃ§uÅŸu ile yÃ¶rÃ¼nge altÄ± uÃ§uÅŸ gerÃ§ekleÅŸtirdi.
          - Deneyler:
            1. UZÄ°KAT: Ä°nsÃ¼lin kaleminin uzaydaki doz aktarÄ±m verimliliÄŸi test edildi.
            2. IvmeRad: Radyasyon dozimetresi ile anlÄ±k radyasyon Ã¶lÃ§Ã¼mÃ¼ yapÄ±ldÄ±.
            3. YUVA: HÃ¼cre dÄ±ÅŸÄ± vezikÃ¼llerin (haberleÅŸme kesecikleri) mikro yerÃ§ekimindeki analizi.
            4. BEACON: Beyindeki kan dolaÅŸÄ±mÄ± ve omurilik sÄ±vÄ±sÄ± hareketleri (KÄ±zÄ±lÃ¶tesi spektroskopisi ile) incelendi.
          
          === Ä°LGÄ°NÃ‡ UZAY HÄ°KAYELERÄ° VE GÃ–REVLER ===
          1. UZAYA GÄ°DEN Ä°LK BORU KEBABI:
          - Tarih: 12 Nisan 2022 (Yuri Gagarin'in uÃ§uÅŸ yÄ±ldÃ¶nÃ¼mÃ¼).
          - Yer: Adana, TÃ¼rkiye.
          - Olay: AlbaSpace ekibi ve kebapÃ§Ä± YaÅŸar AydÄ±n, "Albatros" adlÄ± uzay aracÄ±yla bir porsiyon Adana Boru KebabÄ±'nÄ± stratosfere gÃ¶nderdi.
          - Detay: Kebap yanÄ±nda TÃ¼rk bayraÄŸÄ±, Ã§ocuk isimleri ve tohumlar taÅŸÄ±dÄ±. AraÃ§ Hatay DÃ¶rtyol aÃ§Ä±klarÄ±nda denize indi ve baÅŸarÄ±yla kurtarÄ±ldÄ±.
          
          2. UZAYA GÄ°DEN Ä°LK KURUYEMÄ°Å:
          - Tarih: 25 AÄŸustos 2024.
          - Olay: Ã‡eÅŸitli kuruyemiÅŸler stratosfere gÃ¶nderildi. Ä°skenderun aÃ§Ä±klarÄ±na indi.
          
          3. UZAYA GÄ°DEN ATATÃœRK FOTOÄRAFI:
          - Tarih: 27 Ekim 2022 (Cumhuriyet BayramÄ± ÅŸerefine).
          - Olay: Mustafa Kemal AtatÃ¼rk'Ã¼n fotoÄŸrafÄ± ve 16 Ã§eÅŸit tohum uzaya yollandÄ±. Sinyal kesildiÄŸi iÃ§in kayboldu sanÄ±ldÄ±, ancak 9 ay sonra bir Ã§oban (Halil Ã‡abuk) tarafÄ±ndan Osmaniye'de bir ormanda sapasaÄŸlam bulundu.
          
          === GENEL BÄ°LGÄ°LER VE FELSEFE ===
          - Evren Bilgisi: GÃ¼neÅŸ sistemi (MerkÃ¼r, VenÃ¼s, DÃ¼nya, Mars, JÃ¼piter, SatÃ¼rn, UranÃ¼s, NeptÃ¼n), Karadelikler (M87), Solucan Delikleri.
          - Ã–nemli Ä°simler: Mustafa Kemal AtatÃ¼rk ("Ä°stikbal GÃ¶klerdedir"), Elon Musk, Aziz Sancar, Nikola Tesla, Galileo, Einstein.
          - Astronot Olmak Ä°Ã§in: Matematik, Fen Ã§alÄ±ÅŸÄ±lmalÄ±, spor yapÄ±lmalÄ±, saÄŸlÄ±klÄ± beslenilmeli, yabancÄ± dil Ã¶ÄŸrenilmeli.
          - KitabÄ±n AmacÄ±: Ã‡ocuklara "Ben de yapabilirim" dedirtmek, merak duygusunu ateÅŸlemek.


`;

    // ==========================================================================================
    // 6. Ğ—ĞĞŸĞ ĞĞ¡ Ğš LLM (GROQ)
    // ==========================================================================================
    const messages = [
      { role: "system", content: systemPrompt },
      ...memory.history.slice(-10), // ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 10 ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°
      { role: "user", content: message }
    ];

    let reply = "Hata oluÅŸtu ğŸš€"; // Ğ”ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚
    
    try {
      const apiKey = env.GROQ_API_KEY || "";
      const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
        body: JSON.stringify({
          model: "llama-3.1-8b-instant", // Ğ”ĞµÑˆĞµĞ²Ğ°Ñ Ğ¸ Ğ±Ñ‹ÑÑ‚Ñ€Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ
          messages: messages,
          temperature: 0.6,
          max_tokens: 600 // Ğ§ÑƒÑ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ², Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ¾Ğ±Ñ€Ñ‹Ğ²Ğ°Ğ» Ñ„Ñ€Ğ°Ğ·Ñ‹
        })
      });

      if (!response.ok) throw new Error(`API Status: ${response.status}`);
      
      const json = await response.json();
      reply = json.choices?.[0]?.message?.content || "";

    } catch (err) {
      console.error("Groq Fetch Error:", err);
      reply = "ÃœzgÃ¼nÃ¼m, uzayla baÄŸlantÄ± kesildi! ğŸŒŒ LÃ¼tfen bir dakika sonra tekrar deneyin.";
    }

    // ==========================================================================================
    // 7. ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞšĞ ĞĞ¢Ğ’Ğ•Ğ¢Ğ (ĞŸĞĞ˜Ğ¡Ğš Ğ¢Ğ•Ğ“ĞĞ’ Ğ˜ Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ˜Ğ•)
    // ==========================================================================================
    
    // Ğ˜Ñ‰ĞµĞ¼ Ñ‚ĞµĞ³Ğ¸ <SAVE_NAME> Ğ¸ <SAVE_AGE>
    const nameMatch = reply.match(/<SAVE_NAME:(.*?)>/i);
    if (nameMatch) memory.name = nameMatch[1].trim();

    const ageMatch = reply.match(/<SAVE_AGE:(.*?)>/i);
    if (ageMatch) memory.age = ageMatch[1].trim();

    // Ğ§Ğ¸ÑÑ‚Ğ¸Ğ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¾Ñ‚ Ñ‚ĞµĞ³Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    const cleanReply = reply
      .replace(/<SAVE_NAME:.*?>/gi, "")
      .replace(/<SAVE_AGE:.*?>/gi, "")
      .trim();

    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ
    memory.history.push({ role: "user", content: message });
    memory.history.push({ role: "assistant", content: cleanReply });
    
    // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² KV
    if (sessionId && STORAGE) {
      context.waitUntil(STORAGE.put("sess:" + sessionId, JSON.stringify({
        name: memory.name,
        age: memory.age,
        msgCount: memory.msgCount,
        history: memory.history.slice(-20) // Ğ¥Ñ€Ğ°Ğ½Ğ¸Ğ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 20 ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
      }), { expirationTtl: 604800 })); // 7 Ğ´Ğ½ĞµĞ¹
    }

    // ==========================================================================================
    // 8. TELEGRAM LOGGING (Ğ¤Ğ¾Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ)
    // ==========================================================================================
    if (env.TELEGRAM_TOKEN && env.TELEGRAM_CHAT_ID) {
      const escapeHtml = (s) => String(s || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      const nameText = escapeHtml(memory.name || "Anonim");
      const userText = escapeHtml(message);
      let aiText = escapeHtml(cleanReply);
      const maxLen = 3800; // Telegram limit safety (4096), Ñ€ĞµĞ·ĞµÑ€Ğ² Ğ´Ğ»Ñ Ğ´Ğ¾Ğ¿. Ñ‚ĞµĞºÑÑ‚Ğ°
      if (aiText.length > maxLen) aiText = aiText.slice(0, maxLen) + "â€¦";

      const logText = `ğŸ‘½ <b>Chat Log</b>\nğŸ‘¤ ${nameText}: ${userText}\nğŸ¤– AI: ${aiText}`;
      context.waitUntil(fetch(`https://api.telegram.org/bot${env.TELEGRAM_TOKEN}/sendMessage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chat_id: env.TELEGRAM_CHAT_ID, text: logText, parse_mode: "HTML" })
      }).catch(e => console.error("TG Log Error:", e)));
    }

    // ==========================================================================================
    // 9. ĞĞ¢Ğ’Ğ•Ğ¢ ĞšĞ›Ğ˜Ğ•ĞĞ¢Ğ£
    // ==========================================================================================
    return new Response(JSON.stringify({
      reply: cleanReply,
      saveName: memory.name,
      saveAge: memory.age
    }), { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } });
  }
}






